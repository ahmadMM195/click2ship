{% extends "click2ship_core/templates/layout.html" %}

{% block content %}

<div id="cached-bookings"></div>

<section id="cover">
    <div class="container">
        <div class="quote-header">
            <h2>Shipment Booked Successfully</h2>
            <p class="text-muted mt-2">
                Your shipment has been created. You can print the documents or schedule pickup below.
            </p>
        </div>
    </div>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-6">

                <div class="quote-wrapper">
                    <div class="quote-item flex-column text-center p-4">

                        <h4 class="mb-4">Shipment Actions</h4>

                        <!-- Print Label -->
                        <button id="printLabelBtn"
                                class="nav-btn -outlined mb-3 w-100"
                                disabled>
                            üñ®Ô∏è Print Shipping Label
                        </button>

                        <!-- Print Invoice -->
                        <button id="printInvoiceBtn"
                                class="nav-btn -outlined mb-3 w-100"
                                disabled>
                            üìÑ Print Invoice
                        </button>

                        <!-- Schedule Pickup -->
                        <button id="schedulePickupBtn"
                                class="nav-btn -outlined mb-3 w-100">
                            üöö Schedule Pickup
                        </button>

                        <hr class="my-4">

                        <a href="/dashboard" class="nav-btn w-100">
                            üìä View Dashboard
                        </a>

                        <div id="statusMsg" class="text-muted mt-3"></div>

                    </div>
                </div>

            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const labelBtn   = document.getElementById("printLabelBtn");
    const invoiceBtn = document.getElementById("printInvoiceBtn");
    const pickupBtn  = document.getElementById("schedulePickupBtn");
    const statusMsg  = document.getElementById("statusMsg");

    /* ----------------------------------
       Load shipment documents
    ---------------------------------- */
    fetch("/api/method/click2ship_core.api.call.session_data", {
        credentials: "include"
    })
    .then(res => res.json())
    .then(r => {
        const container = document.getElementById("cached-bookings");
            console.log("container")
            
            if(r.message){
                const data = r.message;
                console.log(data)
                if(Object.keys(data).length === 0){
                    container.innerHTML = "<p>No booking data in cache.</p>";
                } else {
                    container.innerHTML = "<pre>" + JSON.stringify(data, null, 4) + "</pre>";
                }
            }

        const shipment =
            r.message.shipment_details ||
            r.message.data?.shipment_details ||
            r.message.data;

        if (!shipment) {
            statusMsg.innerText = "Shipment data missing.";
            return;
        }

        const labelUrl   = shipment?.doc_url?.label;
        const invoiceUrl = shipment?.doc_url?.invoice;

        if (labelUrl) {
            labelBtn.disabled = false;
            labelBtn.onclick = function () {
                window.open(
                    `/api/method/frappe.utils.file_manager.download_file?file_url=${labelUrl}`,
                    "_blank"
                );
            };
        }

        if (invoiceUrl) {
            invoiceBtn.disabled = false;
            invoiceBtn.onclick = function () {
                window.open(
                    `/api/method/frappe.utils.file_manager.download_file?file_url=${invoiceUrl}`,
                    "_blank"
                );
            };
        }

        if (!labelUrl && !invoiceUrl) {
            statusMsg.innerText = "Documents are still processing. Please refresh.";
        }
    })
    .catch(err => {
        console.error("Failed to load shipment documents:", err);
        statusMsg.innerText = "Failed to load shipment documents.";
    });

    /* ----------------------------------
       Schedule Pickup (Karrio)
    ---------------------------------- */
    pickupBtn.addEventListener("click", function () {
        pickupBtn.disabled = true;
        pickupBtn.innerText = "Scheduling Pickup...";
        statusMsg.innerText = "";
        
        console.log("**************** schedule_proxy_pickup ************************")
        fetch("/api/method/click2ship_core.api.karrio_api.schedule_proxy_pickup", {
            credentials: "include"
        })
        .then(res => res.json())
        .then(r => {
            if (r.message) {
                statusMsg.innerHTML =
                    "<strong style='color:green'>Pickup scheduled successfully.</strong>";
                console.log("Pickup Response:", r.message);
            } else {
                throw new Error("Pickup failed");
            }
        })
        .catch(err => {
            console.error("Pickup error:", err);
            statusMsg.innerHTML =
                "<span style='color:red'>Failed to schedule pickup.</span>";
        })
        .finally(() => {
            pickupBtn.disabled = false;
            pickupBtn.innerText = "Schedule Pickup";
        });
    });

});
</script>

{% endblock %}

